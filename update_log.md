## 更新日志

---

### 2025-08-25 安全更新版本（1.2.5.4）详细更新日志

1. 顺序随机化握手协议（核心创新）

• 实现握手步骤动态随机化：引入32字节随机种子，每次握手生成24种可能的步骤排列组合  
• 步骤顺序完全随机化：4个关键步骤（KeyExchange1/2, KeyConfirm1/2）执行顺序完全随机  
• 抗流量分析增强：防止中间人通过流量特征识别握手模式  

2. 会话类（Session）增强

• 新增角色参数：初始化时指定'client'或'server'，自动设置密钥派生方向  
• 动态密钥派生优化：使用种子码+序列号+标签派生每次通信密钥  
• 双向标签支持：根据角色自动设置"client->server"或"server->client"标签  

3. 服务端握手流程优化

• 修复Session初始化错误：添加role='server'参数传递  
• 步骤编号连续性：引入步骤计数器确保日志编号连续（9-12步）  
• 种子码安全增强：绑定客户端证书指纹，防止中间人攻击  

4. 客户端握手流程优化

• 修复Session初始化错误：添加role='client'参数传递  
• 随机步骤同步：使用相同随机种子生成与服务端一致的步骤顺序  
• 幂等性检查：增加种子码nonce缓存，防止重放攻击  

5. 密钥派生机制升级

• 动态密钥派生：每次通信使用独立派生密钥，增强前向安全性  
• 密钥派生信息扩展：包含协议版本、密码套件、nonce和所有交换数据  
• 密钥长度标准化：固定派生64字节密钥（32字节发送+32字节接收）  

6. 错误处理与日志增强

• 安全日志记录：添加错误频率限制，防止日志泛洪攻击  
• 详细错误上下文：记录错误时的连接地址和当前状态  
• 握手超时机制：30秒握手超时，防止资源耗尽攻击  

7. 性能与资源优化

• 连接数限制：通过信号量限制最大并发连接数（100）  
• 计算资源限制：限制并发计算量（50个并发）  
• 内存优化：限制最大帧大小（1MB），防止内存耗尽攻击  

8. 证书验证增强

• 双CA支持：同时支持常规CA和匿名CA证书验证  
• 证书指纹绑定：在种子码中包含客户端证书指纹  
• 短期临时证书：匿名连接使用30分钟有效期的临时证书  

9. 协议兼容性

• 保持原有消息格式：确保与1.2.5.3版本兼容  
• 新增字段向后兼容：随机种子和角色参数不影响旧版解析  

10. 安全审计增强

• nonce重复使用检测：实时检查并阻止nonce重放攻击  
• 熵源验证：使用香农熵检测种子码随机性质量  
• 序列号严格校验：防止序列号篡改和重放攻击  

_本次更新重点实现了"顺序随机化握手"创新机制，显著提升协议对抗流量分析和中间人攻击的能力，同时修复了关键安全漏洞，增强了系统的整体安全性。_

---

### 2025-08-25 安全修复版本（1.2.5.3）

1. CA脚本更新 (ca.py)

• 修复签名算法问题：修正了Ed25519签名时指定哈希算法的错误

• 添加匿名CA证书：新增匿名CA证书生成功能

• 时间处理优化：使用datetime.timezone.utc替代弃用的utcnow()

• 证书链完善：生成中级CA证书并创建ca_cert.pem

• 证书指纹输出：添加所有证书的SHA256指纹显示

• 文件管理优化：自动创建ca_cert.pem文件

2. 客户端更新 (client.py)

• 临时证书生成：添加完整的临时证书生成功能

• 签名算法修复：正确实现Ed25519签名（使用algorithm=None)

• 时间处理修复：使用带时区的UTC时间替代弃用的utcnow()

• 匿名模式支持：当没有固定证书时自动生成临时证书

• 错误处理增强：改进证书加载和验证的错误处理

• 日志优化：添加更详细的临时证书生成日志

3. 服务端更新 (server.py)

• 匿名证书验证：支持验证匿名CA签发的临时证书

• 双CA验证机制：先尝试普通CA验证，失败后尝试匿名CA验证

• 证书绑定机制：将临时证书与客户端指纹绑定

• 错误处理优化：改进证书验证失败的错误处理

• 日志增强：添加详细的证书验证日志

4. 安全协议更新

• 前向保密增强：每次会话使用唯一的临时密钥对

• 抗重放保护：改进nonce使用检查和缓存机制

• 序列号验证：严格检查数据帧序列号

• 密钥派生优化：使用更安全的HKDF密钥派生方法

• 熵源验证：添加种子码的熵值检查

5. 其他改进

• 资源限制：添加连接数和计算资源限制

• 日志安全：防止日志泛洪攻击的安全日志机制

• 错误处理：统一和改进所有错误处理流程

• 文档注释：添加和更新所有关键函数的文档注释

• 代码优化：重构和优化代码结构，提高可读性

主要安全特性更新

1. 无固定证书模式：
   • 客户端无需预先配置证书

   • 每次连接自动生成临时证书

   • 临时证书短期有效（30分钟）

2. 双向认证：
   • 客户端验证服务器证书

   • 服务器验证客户端证书（固定或临时）

3. 完美前向保密：
   • 每次会话使用唯一临时密钥

   • 历史会话无法被解密

4. 抗中间人攻击：
   • 严格的证书验证

   • 密钥交换过程保护

   • 加密通道早期建立

5. 隐私保护：
   • 不暴露固定身份信息

   • 每次连接使用新身份

   • 临时证书自动销毁

_这些更新显著提高了系统的安全性和可用性，同时保持了与传统证书方案相当的安全级别。_

---

### 2025-08-24 安全修复版本（1.2.5.2）

修复问题：
1. 协议解析错误修复：  
   • 修复了 ServerHello 消息格式不匹配的问题

   • 解决了客户端和服务端在解析协议帧时的长度不一致问题

   • 优化了协议帧解析逻辑，使用固定偏移量代替 split 方法

2. 二进制数据验证修复：  
   • 修复了 KeyExchange1/KeyExchange2 数据验证错误

   • 修改了 validate_field 函数，添加了 is_text 参数区分文本和二进制字段

   • 对于密钥交换数据等二进制字段，不再检查可打印字符范围

3. 状态机增强：  
   • 添加了更严格的状态转换检查

   • 确保每个握手步骤都在正确的状态下执行

   • 防止协议状态机错乱攻击

4. 安全增强：  
   • 添加了详细的错误日志和安全日志记录

   • 实现了日志泛洪防护机制

   • 加强了随机数生成和熵值检查

   • 完善了序列号验证机制

5. 性能优化：  
   • 降低了最大帧大小限制（50MB → 1MB）

   • 添加了连接数和计算资源限制

   • 优化了内存使用和资源管理

---

### 2025-08-24 安全修复版本（1.2.5.1）

1. Nonce重放防护
   • 添加服务端nonce缓存

   • 实现nonce过期清理机制

   • 防止重放攻击导致密钥重用

2. 种子码安全传输
   • 使用握手密钥加密种子码

   • 添加关联数据完整性验证

   • 实现幂等性检查防重放

3. 熵源增强
   • 混合os.urandom和secrets.token_bytes

   • 添加熵值阈值检查

   • 优化随机性检测算法

4. 帧格式标准化
   • 统一DATA帧格式：DATA+8字节序列号+密文

   • 移除文本分隔符，改用二进制格式

   • 添加严格长度验证

5. 序列号一致性
   • 客户端和服务端序列号统一从1开始

   • 发送/接收后自动递增

   • 添加序列号连续性检查

6. 错误处理增强
   • 详细错误日志记录

   • 堆栈跟踪输出

   • 解密失败立即断开连接

7. 密钥派生加固
   • 包含完整握手数据到HKDF info

   • 添加协议版本和密码套件标识

   • 使用临时密钥确保前向安全

8. 证书验证强化
   • 添加CA证书验证链

   • 实现严格签名检查

   • 证书与身份绑定

9. 性能优化
   • 握手超时设置

   • 大帧尺寸限制

   • 连接保活机制

10. 完整状态机
    ◦ 13步握手流程

    ◦ 严格消息顺序验证

    ◦ 双向认证机制

